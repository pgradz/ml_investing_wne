import pandas as pd
import datetime
from io import StringIO
import unittest
from unittest.mock import patch
from ml_investing_wne.performance_evaluator import PerformanceEvaluator



class TestPerformanceEvaluatory(unittest.TestCase):

    def setUp(self) -> None:
        
        test_data_triple_barrier = StringIO('''datetime,open,close,high,low,cost,trade,prediction,prc_change,time_step,barrier_touched,barrier_touched_date,bottom_barrier,top_barrier,budget,transaction
        2022-04-01 01:52:00,45800.0,45047.14,46000.0,45020.0,0.001,0.0,0.3656813402970632,0.05000000000000008,8.0,top,2022-04-03 23:05:00,42794.782999999996,47299.497,94.905,sell
        2022-04-01 08:22:00,45047.14,45167.0,45203.0,44200.0,0.001,0.0,0.38172109921773273,0.04999999999999997,7.0,top,2022-04-03 23:05:00,42908.65,47425.35,,
        2022-04-01 14:13:00,45167.0,45691.29,45698.92,44701.01,0.001,0.5,0.42607152462005615,-0.05000000000000001,15.0,bottom,2022-04-06 18:24:00,43406.7255,47975.8545,,
        2022-04-01 15:09:00,45691.29,46493.7,46530.0,45536.27,0.001,0.5,0.4039248426755269,-0.049999999999999954,13.0,bottom,2022-04-06 15:32:00,44169.015,48818.384999999995,,
        2022-04-02 00:53:00,46493.7,46989.12,46998.0,45893.98,0.001,0.5,0.42439528306325275,-0.04999999999999996,10.0,bottom,2022-04-06 04:56:00,44639.664000000004,49338.576,,
        2022-04-02 15:37:00,46989.12,46250.0,47213.0,46225.75,0.001,0.0,0.39192580183347064,-0.05,11.0,bottom,2022-04-06 15:32:00,43937.5,48562.5,,
        2022-04-03 06:06:00,46250.0,46490.29,46494.72,45530.92,0.001,0.0,0.37425705293814343,-0.04999999999999995,10.0,bottom,2022-04-06 15:32:00,44165.7755,48814.8045,,
        2022-04-03 22:01:00,46490.29,47033.94,47042.37,46076.92,0.001,0.5,0.4614487091700236,-0.05,7.0,bottom,2022-04-06 04:56:00,44682.243,49385.637,,
        2022-04-03 23:05:00,47033.95,46461.99,47444.11,46432.45,0.001,0.5,0.4164403776327769,-0.049999999999999926,8.0,bottom,2022-04-06 15:32:00,44138.8905,48785.089499999995,94.810095,No trade
        2022-04-04 15:06:00,46462.0,45631.74,46666.0,45600.1,0.001,0.0,0.39822036524613696,-0.04999999999999999,8.0,bottom,2022-04-06 18:24:00,43350.153,47913.327,99.45104915025,sell
        2022-04-04 20:21:00,45631.74,46158.76,46181.21,45118.0,0.001,0.5,0.4264639914035797,-0.05000000000000004,6.0,bottom,2022-04-06 15:32:00,43850.822,48466.698000000004,,
        2022-04-05 12:25:00,46158.77,47069.78,47099.99,46100.0,0.001,0.5,0.4499419331550598,-0.05000000000000003,3.0,bottom,2022-04-06 04:56:00,44716.291,49423.269,,
        2022-04-05 14:06:00,47069.79,46173.88,47200.0,46088.0,0.001,0.0,0.3804220308860143,-0.05000000000000007,4.0,bottom,2022-04-06 15:32:00,43865.185999999994,48482.574,,
        2022-04-06 00:08:00,46173.89,45250.68,46220.21,45250.68,0.001,0.0,0.3774845202763875,-0.04999999999999999,5.0,bottom,2022-04-07 00:51:00,42988.146,47513.214,,
        2022-04-06 04:56:00,45250.68,45366.53,45375.38,44412.0,0.001,0.0,0.3826226095358531,-0.050000000000000065,4.0,bottom,2022-04-07 00:51:00,43098.203499999996,47634.8565,,
        2022-04-06 13:44:00,45366.53,44575.15,45507.14,44529.01,0.001,0.5,0.4026870479186376,-0.04999999999999999,9.0,bottom,2022-04-08 22:20:00,42346.3925,46803.9075,,
        2022-04-06 15:32:00,44575.16,43744.54,44698.5,43716.73,0.001,0.5,0.41538770000139874,-0.049999999999999975,12.0,bottom,2022-04-11 13:32:00,41557.313,45931.767,,
        2022-04-06 18:24:00,43744.54,43346.07,44298.61,43177.11,0.001,0.5,0.4084707945585251,-0.050000000000000044,11.0,bottom,2022-04-11 13:32:00,41178.7665,45513.3735,99.35159810109975,No trade
        2022-04-07 00:51:00,43346.07,42861.78,44041.1,42800.0,0.001,0.0,0.3897036761045456,-0.05,11.0,bottom,2022-04-11 17:16:00,40718.691,45004.869,104.21485882814859,sell
        2022-04-07 11:08:00,42861.79,43697.22,43747.05,42727.35,0.001,0.5,0.4236319065093994,-0.04999999999999993,9.0,bottom,2022-04-11 13:32:00,41512.359000000004,45882.081,,
        2022-04-08 08:48:00,43697.23,43965.0,43965.0,43024.86,0.001,0.5,0.4135040690501531,-0.05,7.0,bottom,2022-04-11 09:58:00,41766.75,46163.25,,
        2022-04-08 13:02:00,43964.99,43086.95,43970.62,43066.34,0.001,0.5,0.4180746128161748,-0.050000000000000086,7.0,bottom,2022-04-11 13:32:00,40932.60249999999,45241.2975,,
        2022-04-08 14:52:00,43086.95,43753.54,43775.0,42751.01,0.001,0.5,0.4162856837113698,-0.05000000000000007,6.0,bottom,2022-04-11 13:32:00,41565.863,45941.217000000004,,
        2022-04-08 17:16:00,43753.55,43003.95,43961.99,42985.0,0.001,0.5,0.42370829979578656,-0.05000000000000005,5.0,bottom,2022-04-11 13:32:00,40853.752499999995,45154.1475,,
        2022-04-08 22:20:00,43003.95,42287.12,43320.76,42251.11,0.001,0.5,0.43106046815713245,-0.04999999999999999,6.0,bottom,2022-04-11 20:06:00,40172.764,44401.476,,
        2022-04-10 17:22:00,42287.12,43146.08,43146.08,42107.14,0.001,0.5,0.4058677355448405,-0.050000000000000086,3.0,bottom,2022-04-11 13:32:00,40988.776,45303.384000000005,,
        2022-04-10 22:17:00,43146.07,42388.0,43410.3,42388.0,0.001,0.5,0.42915206650892895,-0.05000000000000004,4.0,bottom,2022-04-11 20:06:00,40268.6,44507.4,,
        2022-04-11 09:58:00,42388.0,41702.14,42564.06,41630.92,0.001,0.5,0.4350874324639638,-0.050000000000000086,3.0,bottom,2022-04-11 20:06:00,39617.032999999996,43787.247,,
        2022-04-11 13:32:00,41702.15,40798.32,41702.15,40733.0,0.001,0.5,0.46201377113660175,-0.04999999999999994,15.0,bottom,2022-04-18 12:56:00,38758.404,42838.236,,
        2022-04-11 17:16:00,40798.31,40333.6,41220.9,40280.0,0.001,0.5,0.44889875253041583,0.05000000000000001,21.0,top,2022-04-21 10:19:00,38316.92,42350.28,104.11064396932045,No trade
        ''')

        test_data_next_bar = StringIO('''datetime,open,close,high,low,cost,trade,prediction,prc_change,budget,transaction
        2022-04-01 01:52:00,45800.0,45047.14,46000.0,45020.0,0.001,0.5,0.4459776083628337,0.002660768252989998,100.0,No trade
        2022-04-01 01:52:00,45800.0,45047.14,46000.0,45020.0,0.001,0.5,0.4459776083628337,0.002660768252989998,100.0,No trade
        2022-04-01 08:22:00,45047.14,45167.0,45203.0,44200.0,0.001,0.5,0.4738190869490306,0.011607811012464886,100.0,No trade
        2022-04-01 08:22:00,45047.14,45167.0,45203.0,44200.0,0.001,0.5,0.4738190869490306,0.011607811012464886,100.0,No trade
        2022-04-01 14:13:00,45167.0,45691.29,45698.92,44701.01,0.001,0.5,0.4124191502730052,0.01756155275983673,100.0,No trade
        2022-04-01 14:13:00,45167.0,45691.29,45698.92,44701.01,0.001,0.5,0.4124191502730052,0.01756155275983673,100.0,No trade
        2022-04-01 15:09:00,45691.29,46493.7,46530.0,45536.27,0.001,0.5,0.4671181042989095,0.010655637215364777,100.0,No trade
        2022-04-01 15:09:00,45691.29,46493.7,46530.0,45536.27,0.001,0.5,0.4671181042989095,0.010655637215364777,100.0,No trade
        2022-04-02 00:53:00,46493.7,46989.12,46998.0,45893.98,0.001,0.0,0.3953445851802826,-0.015729598681567203,101.47138690828857,sell
        2022-04-02 00:53:00,46493.7,46989.12,46998.0,45893.98,0.001,0.0,0.3953445851802826,-0.015729598681567203,101.47138690828857,sell
        2022-04-02 15:37:00,46989.12,46250.0,47213.0,46225.75,0.001,0.5,0.4444696108500163,0.005195459459459428,101.36991552138028,No trade
        2022-04-02 15:37:00,46989.12,46250.0,47213.0,46225.75,0.001,0.5,0.4444696108500163,0.005195459459459428,101.36991552138028,No trade
        2022-04-03 06:06:00,46250.0,46490.29,46494.72,45530.92,0.001,0.0,0.39104970296223956,0.011693839724381094,100.08432746442281,sell
        2022-04-03 06:06:00,46250.0,46490.29,46494.72,45530.92,0.001,0.0,0.39104970296223956,0.011693839724381094,100.08432746442281,sell
        2022-04-03 22:01:00,46490.29,47033.94,47042.37,46076.92,0.001,0.5,0.4104921917120616,-0.012160367598376909,99.98424313695838,No trade
        2022-04-03 22:01:00,46490.29,47033.94,47042.37,46076.92,0.001,0.5,0.4104921917120616,-0.012160367598376909,99.98424313695838,No trade
        2022-04-03 23:05:00,47033.95,46461.99,47444.11,46432.45,0.001,0.5,0.4553160071372986,-0.017869445540322326,99.98424313695838,No trade
        2022-04-03 23:05:00,47033.95,46461.99,47444.11,46432.45,0.001,0.5,0.4553160071372986,-0.017869445540322326,99.98424313695838,No trade
        2022-04-04 15:06:00,46462.0,45631.74,46666.0,45600.1,0.001,0.5,0.41319115956624347,0.011549417138158713,99.98424313695838,No trade
        2022-04-04 15:06:00,46462.0,45631.74,46666.0,45600.1,0.001,0.5,0.41319115956624347,0.011549417138158713,99.98424313695838,No trade
        2022-04-04 20:21:00,45631.74,46158.76,46181.21,45118.0,0.001,0.0,0.39112308621406555,0.01973666536969354,97.91287670033424,sell
        2022-04-04 20:21:00,45631.74,46158.76,46181.21,45118.0,0.001,0.0,0.39112308621406555,0.01973666536969354,97.91287670033424,sell
        2022-04-05 12:25:00,46158.77,47069.78,47099.99,46100.0,0.001,0.5,0.47269879778226215,-0.01903344353850822,97.8149638236339,No trade
        2022-04-05 12:25:00,46158.77,47069.78,47099.99,46100.0,0.001,0.5,0.47269879778226215,-0.01903344353850822,97.8149638236339,No trade
        2022-04-05 14:06:00,47069.79,46173.88,47200.0,46088.0,0.001,0.0,0.38614781697591144,-0.019993987942966807,99.67090435593441,sell
        2022-04-05 14:06:00,47069.79,46173.88,47200.0,46088.0,0.001,0.0,0.38614781697591144,-0.019993987942966807,99.67090435593441,sell
        2022-04-06 00:08:00,46173.89,45250.68,46220.21,45250.68,0.001,0.5,0.4045351246992747,0.002560182521013976,99.57123345157848,No trade
        2022-04-06 00:08:00,46173.89,45250.68,46220.21,45250.68,0.001,0.5,0.4045351246992747,0.002560182521013976,99.57123345157848,No trade
        2022-04-06 04:56:00,45250.68,45366.53,45375.38,44412.0,0.001,0.5,0.4213476280371348,-0.017444137781752245,99.57123345157848,No trade
        2022-04-06 04:56:00,45250.68,45366.53,45375.38,44412.0,0.001,0.5,0.4213476280371348,-0.017444137781752245,99.57123345157848,No trade
        2022-04-06 13:44:00,45366.53,44575.15,45507.14,44529.01,0.001,0.0,0.3998922010262807,-0.01863392495594518,101.3252097071426,sell
        2022-04-06 13:44:00,45366.53,44575.15,45507.14,44529.01,0.001,0.0,0.3998922010262807,-0.01863392495594518,101.3252097071426,sell
        2022-04-06 15:32:00,44575.16,43744.54,44698.5,43716.73,0.001,0.5,0.4147042433420817,-0.009109022520296328,101.22388449743546,No trade
        2022-04-06 15:32:00,44575.16,43744.54,44698.5,43716.73,0.001,0.5,0.4147042433420817,-0.009109022520296328,101.22388449743546,No trade
        2022-04-06 18:24:00,43744.54,43346.07,44298.61,43177.11,0.001,0.5,0.44661901394526166,-0.011172639180437871,101.22388449743546,No trade
        2022-04-06 18:24:00,43744.54,43346.07,44298.61,43177.11,0.001,0.5,0.44661901394526166,-0.011172639180437871,101.22388449743546,No trade
        2022-04-07 00:51:00,43346.07,42861.78,44041.1,42800.0,0.001,0.5,0.422758827606837,0.019491491020671603,101.22388449743546,No trade
        2022-04-07 00:51:00,43346.07,42861.78,44041.1,42800.0,0.001,0.5,0.422758827606837,0.019491491020671603,101.22388449743546,No trade
        2022-04-07 11:08:00,42861.79,43697.22,43747.05,42727.35,0.001,0.5,0.4744930863380432,0.006128078628342859,101.22388449743546,No trade
        2022-04-07 11:08:00,42861.79,43697.22,43747.05,42727.35,0.001,0.5,0.4744930863380432,0.006128078628342859,101.22388449743546,No trade
        2022-04-08 08:48:00,43697.23,43965.0,43965.0,43024.86,0.001,0.5,0.4952418903509776,-0.01997156829296043,101.22388449743546,No trade
        2022-04-08 08:48:00,43697.23,43965.0,43965.0,43024.86,0.001,0.5,0.4952418903509776,-0.01997156829296043,101.22388449743546,No trade
        2022-04-08 13:02:00,43964.99,43086.95,43970.62,43066.34,0.001,0.5,0.5261707703272501,0.015470809607085245,101.22388449743546,No trade
        2022-04-08 13:02:00,43964.99,43086.95,43970.62,43066.34,0.001,0.5,0.5261707703272501,0.015470809607085245,101.22388449743546,No trade
        2022-04-08 14:52:00,43086.95,43753.54,43775.0,42751.01,0.001,0.5,0.45217689871788025,-0.01713209948269334,101.22388449743546,No trade
        2022-04-08 14:52:00,43086.95,43753.54,43775.0,42751.01,0.001,0.5,0.45217689871788025,-0.01713209948269334,101.22388449743546,No trade
        2022-04-08 17:16:00,43753.55,43003.95,43961.99,42985.0,0.001,0.5,0.4551383356253306,-0.01666893390025792,101.22388449743546,No trade
        2022-04-08 17:16:00,43753.55,43003.95,43961.99,42985.0,0.001,0.5,0.4551383356253306,-0.01666893390025792,101.22388449743546,No trade
        2022-04-08 22:20:00,43003.95,42287.12,43320.76,42251.11,0.001,0.5,0.46371309955914813,0.020312567987604613,101.22388449743546,No trade
        2022-04-08 22:20:00,43003.95,42287.12,43320.76,42251.11,0.001,0.5,0.46371309955914813,0.020312567987604613,101.22388449743546,No trade
        2022-04-10 17:22:00,42287.12,43146.08,43146.08,42107.14,0.001,0.5,0.498830646276474,-0.017570078208727247,101.22388449743546,No trade
        2022-04-10 17:22:00,42287.12,43146.08,43146.08,42107.14,0.001,0.5,0.498830646276474,-0.017570078208727247,101.22388449743546,No trade
        2022-04-10 22:17:00,43146.07,42388.0,43410.3,42388.0,0.001,0.5,0.42015086611111957,-0.016180522789468688,101.22388449743546,No trade
        2022-04-10 22:17:00,43146.07,42388.0,43410.3,42388.0,0.001,0.5,0.42015086611111957,-0.016180522789468688,101.22388449743546,No trade
        2022-04-11 09:58:00,42388.0,41702.14,42564.06,41630.92,0.001,0.5,0.4637809495131175,-0.021673228280371215,101.22388449743546,No trade
        2022-04-11 09:58:00,42388.0,41702.14,42564.06,41630.92,0.001,0.5,0.4637809495131175,-0.021673228280371215,101.22388449743546,No trade
        2022-04-11 13:32:00,41702.15,40798.32,41702.15,40733.0,0.001,0.5,0.4566175738970439,-0.011390665105818099,101.22388449743546,No trade
        2022-04-11 13:32:00,41702.15,40798.32,41702.15,40733.0,0.001,0.5,0.4566175738970439,-0.011390665105818099,101.22388449743546,No trade
        2022-04-11 17:16:00,40798.31,40333.6,41220.9,40280.0,0.001,0.5,0.4507677952448527,-0.01848359680266587,101.22388449743546,No trade
        2022-04-11 17:16:00,40798.31,40333.6,41220.9,40280.0,0.001,0.5,0.4507677952448527,-0.01848359680266587,101.22388449743546,No trade
        2022-04-11 20:06:00,40333.6,39588.09,40598.43,39566.2,0.001,0.5,0.4737172822157542,-0.0038526738723690945,101.22388449743546,No trade
        2022-04-11 20:06:00,40333.6,39588.09,40598.43,39566.2,0.001,0.5,0.4737172822157542,-0.0038526738723690945,101.22388449743546,No trade
        2022-04-11 21:49:00,39588.08,39435.57,40269.6,39275.68,0.001,0.5,0.5059709250926971,0.017118555659269008,101.22388449743546,No trade
         ''')                                          

        test_data_daily_records = StringIO('''datetime,open,high,low,close,volume
        2022-04-01 00:00:00,45510.35,46720.09,44200.0,46283.49,56271.06474
        2022-04-02 00:00:00,46283.49,47213.0,45620.0,45811.0,37073.53582
        2022-04-03 00:00:00,45810.99,47444.11,45530.92,46407.35,33394.67794
        2022-04-04 00:00:00,46407.36,46890.71,45118.0,46580.51,44641.87514
        2022-04-05 00:00:00,46580.5,47200.0,45353.81,45497.55,42192.74852
        2022-04-06 00:00:00,45497.54,45507.14,43121.0,43170.47,60849.32936
        2022-04-07 00:00:00,43170.47,43900.99,42727.35,43444.19,37396.54156
        2022-04-08 00:00:00,43444.2,43970.62,42107.14,42252.01,42375.04203
        2022-04-09 00:00:00,42252.02,42800.0,42125.48,42753.97,17891.66047
        2022-04-10 00:00:00,42753.96,43410.3,41868.0,42158.85,22771.09403
        2022-04-11 00:00:00,42158.85,42414.71,39200.0,39530.45,63560.44721
        ''')            
                                             
        self.df_test_triple = pd.read_table(test_data_triple_barrier, sep=',', parse_dates=['datetime'])
        self.df_test_next_bar = pd.read_table(test_data_next_bar, sep=',', parse_dates=['datetime'])
        self.daily_records = pd.read_table(test_data_daily_records, sep=',', parse_dates=['datetime'])


    def test_3_barriers(self):
            
        performance_evaluator = PerformanceEvaluator('dummy_path', daily_records_dataframe=self.daily_records, end_date=datetime.date(2022, 4, 12))
        performance_evaluator.triple_barrier = True
        performance_evaluator.backtest = self.df_test_triple
        performance_evaluator.format_backtest_results()
        performance_evaluator.accuracy_by_threshold(performance_evaluator.backtest,0.5, 0.5, type='3. accuracy')
        performance_evaluator.accuracy_by_threshold(performance_evaluator.trades,0.4, 0.6, type='2. correct_transactions')
        performance_evaluator.combine_trades_and_daily_close()
        performance_evaluator.get_daily_returns()
        performance_evaluator.format_daily_returns()
        performance_evaluator.compute_financial_performance()

        self.assertAlmostEqual(performance_evaluator.metrics['1. gain_loss'][0], 4.11, places=2)
        self.assertEqual(performance_evaluator.metrics['3. accuracy'][0], 90, "Should be 90")
        self.assertEqual(performance_evaluator.metrics['2. correct_transactions'][0], 2/3*100, "Should be 0.66")
        self.assertAlmostEqual(performance_evaluator.metrics['6. max_drawdown'][0], 7.25, places=2)
        self.assertAlmostEqual(performance_evaluator.metrics['4. sharpe_ratio'][0], 2.74, places=2)
        self.assertAlmostEqual(performance_evaluator.metrics['5. sortino_ratio'][0], 8.98, places=2)
        self.assertAlmostEqual(performance_evaluator.metrics['7. share_of_time_active'][0], 80.88, places=2)
        self.assertEqual(performance_evaluator.metrics['8. no. of trades'][0], 3, "Should be 3")

    def test_next_bat(self):
            
        performance_evaluator = PerformanceEvaluator('dummy_path', daily_records_dataframe=self.daily_records, end_date=datetime.date(2022, 4, 12))
        performance_evaluator.triple_barrier = False
        performance_evaluator.backtest = self.df_test_next_bar
        performance_evaluator.format_backtest_results()
        performance_evaluator.accuracy_by_threshold(performance_evaluator.backtest,0.5, 0.5, type='3. accuracy')
        performance_evaluator.accuracy_by_threshold(performance_evaluator.trades,0.4, 0.6, type='2. correct_transactions')
        performance_evaluator.combine_trades_and_daily_close()
        performance_evaluator.get_daily_returns()
        performance_evaluator.format_daily_returns()
        performance_evaluator.compute_financial_performance()

        self.assertAlmostEqual(performance_evaluator.metrics['1. gain_loss'][0], 1.22, places=2)
        self.assertAlmostEqual(performance_evaluator.metrics['3. accuracy'][0], 61.90, places=2)
        self.assertEqual(performance_evaluator.metrics['2. correct_transactions'][0], 60.0, "Should be 60")
        self.assertAlmostEqual(performance_evaluator.metrics['6. max_drawdown'][0], 3.60, places=2)
        self.assertAlmostEqual(performance_evaluator.metrics['4. sharpe_ratio'][0], 2.13, places=2)
        self.assertAlmostEqual(performance_evaluator.metrics['5. sortino_ratio'][0], 12.38, places=2)
        self.assertAlmostEqual(performance_evaluator.metrics['7. share_of_time_active'][0], 20.33, places=2)
        self.assertEqual(performance_evaluator.metrics['8. no. of trades'][0], 5, "Should be 5")

if __name__ == '__main__':
    unittest.main()


